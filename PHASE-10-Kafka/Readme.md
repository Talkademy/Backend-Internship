<div dir='rtl' align="justify">

# آشنایی با کافکا
با پیدایش کافکا روز به روز استفاده از آن در حال افزایش است. بیش از ۸۰ درصد شرکتهای فرچون ۱۰۰(Fortune 100) از کافکا استفاده می کنند. بخشی از این شرکت ها شامل ده شرکت مسافرتی برتر ، هشت بانک از ده بانک برتر ، هشت شرکت از ده شرکت بیمه برتر ، 9 شرکت از ده شرکت برتر مخابراتی و بسیاری دیگر هستند. لینکدین ، مایکروسافت و نت‌فلیکس با کافکا روزانه بیش از یک میلیارد پیام را پردازش می کنند.


کافکا به عنوان یک استاندارد برای ساخت سامانه های مبتنی بر رویداد(Event-driven)، قابل
اعتماد و با حجم دیتا بالا تکامل یافته است. معماری منحصر به فرد و در عین حال ساده ، کافکا را به یک کامپوننت با کاربرد آسان تبدیل کرده است که به خوبی با معماری های موجود ادغام می شود. از نگاهی دیگر ، کافکا یک بستر پیام رسانی است که تولید کنندگان پیام را از مصرف کنندگان پیام جدا می کند و در عین حال قابلیت اطمینان پیام رسانی را در مقیاس بالا به مصرف کنندگان ارائه می دهد. تولیدکنندگان، پیام‌ها را به کافکا ارسال می کنند و کافکا در موجودیتهایی موسوم به تاپیک ذخیره می کند و پیام ها را به روشی مطمئن به یک یا چند مصرف کننده تحویل می دهد.

![Event-Driven-Architecture-Kafka-Pattern](Event-Driven-Architecture-Kafka-Pattern.png)


## رابط‌های کافکا Kafka API
کافکا دارای چهار رابط اصلی است:

۱.تولید کننده

۲.مصرف‌کننده

۳.استریمر

۴.متصل کننده


### تولید کننده Producer:
تولید کننده نقش تولید دیتا در یک یا چند تاپیک کافکا را دارد. تولید کننده با رابط برنامه نویسی خود دیتاها را در کافکا ذخیره می‌کند.
### مصرف کننده consumer:
مصرف کننده با رابط برنامه نویسی خود به کافکا متصل شده و دیتاها را از یک یا چند تاپیک می‌خواند.
### جریان‌ها Streams :
دیتاهای ذخیره شده در کافکا گاهی اوقات برای اهداف مختلف نیاز به تغییر ، تجمیع یا همبستگی دارند.استریم‌ها برنامه‌های هستند که دیتاهای را از کافکا خوانده پردازش مورد نیاز را برروی آنها اعمال می‌کنند و خروجی را در کافکا می‌نویسند.
### متصل کننده Connector :
متصل کنندها برنامه‌های از قبل توسعه یافته‌ای هستند که وظیفه انتقال دیتا از سامانه های دیگر به داخل کافکا را دارند مثلا متصل کننده‌ Mysql وظیفه انتقال تغییرات روی دیتابیس و جداول را به کافکا دارد.


## معماری کافکا
یکی از کتابهای که می‌تواند به درک شما از کافکا کمک کند، کتاب [Kafka: The Definitive Guide](https://www.confluent.io/resources/kafka-the-definitive-guide/) می‌باشد

در این قسمت به اصطلاحات زیر می‌پردازیم

- تاپیک و پارتیشن‌ Topic And Partition
- خوشه و کارگزار در کافکا Cluster & Broker


## تاپیک و پارتیشن‌ Topic And Partition
پیام ها در کافکا به تاپیک‌ها دسته بندی می شوند. نزدیکترین مقایسه برای تاپیک ، جدول پایگاه داده یا پوشه ای در سامانه فایل است. هر تاپیک به تعدادی پارتیشن تقسیم می شوند.پیام ها در هر پارتیشن در انتهای آن نوشته می‌شوند و به ترتیب نوشتن پیام برای مصرف‌کنندگان در درسترس است. توجه داشته باشید که برای یک تاپیک به طور معمول چندین پارتیشن وجود دارد، هیچ تضمینی برای مرتبسازی زمان پیام در کل تاپیک وجود ندارد و پیام‌ها فقط در یک پارتیشن مرتب شده هستند.

شکل زیر تاپیکی با چهار پارتیشن را نشان می دهد که پیام‌های در آن درج شده است با چنین روشی است که کافکا مقیاس پذیری را فراهم می کند. هر پارتیشن می تواند در یک سرور میزبانی شود ، به این معنی که یک تاپیک واحد می تواند به صورت افقی در چندین سرور توزیع شود تا عملکرد بهتر و توزیع شده‌ای را ارائه دهد.

![kafka1](https://user-images.githubusercontent.com/43606924/125408587-51340b00-e3d0-11eb-95db-e6cd0c40adba.png)

## خوشه و کارگزار  Cluster & Broker
کافکا یک برنامه توزیع شده است و وظیفه دارد که در صورت بروز مشکل بار را بین کارگزارهای خود توزیع کند. یک سرور کافکا را کارگزار می نامند. کارگزار پیام های تولید کنندگان را دریافت می کند، offset (شناسه یکتای افزایشی) به آنها اختصاص می دهد و پیام ها را به بر روی دیسک ذخیره می کند. کارگزاران همچنین به مصرف کنندگان سرویس می دهند و درخواست های مصرف کنندگان برای واکشی پیام‌های ذخیره شده بروری دیسک را پاسخ می‌دهند. هر چند که کارایی یک کارگزار وابسته به سخت‌افزاری است که برروی آن اجرا می‌شود با این حال به راحتی می تواند هزاران پارتیشن را اداره کند و میلیون ها پیام در ثانیه را پاسخگو باشد.
کارگزارانِ کافکا برای فعالیت به عنوان بخشی از یک خوشه طراحی شده اند. در یک مجموعه از کارگزاران ، یک کارگزار همچنین به عنوان کنترل کننده (controller) خوشه عمل می کند (که به طور خودکار توسط بقیه اعضای زنده انتخاب می شود). کنترل کننده مسئول امور جاری خوشه از جمله اختصاص پارتیشن به کارگزاران و نظارت بر خرابی کارگزاران می‌باشد. هر پارتیشن به یک کارگزار در خوشه تعلق دارد و آن کارگزار رهبر (Leader) آن پارتیشن نامیده می شود. یک پارتیشن ممکن است به چندین کارگزار اختصاص داده شود که منجر به این می شود که برای یک پارتیشن چندین همتاسازی Replication در نظر گرفته شود. در صورت بروز مشکل کارگزار دیگری می تواند رهبری این پارتیشن را بر عهده بگیرد. در صورت بروز مشکل در یک کارگزار ، تمامی مصرف کنندگان و تولیدکنندگان فعال، به پارتیشن مورد نظر رهبر متصل شود.

## چرا از کافکا استفاده می‌کنیم
- چندین تولید کننده به صورت همزمان (Multiple Producers)

کافکا می تواند به طور یکپارچه از عهده چندین تولید کننده برآید، کلاینت می‌تواند به صورت همزمان در چندین تاپیک عمل درج انجام دهد و یا اینکه چندین کلاینت در یک تاپیک عمل درج را انجام دهند. این ویژگی سامانه را برای جمع‌آوری داده ها از چندین منبع متفاوت ایده آل می کند. به عنوان مثال، سایتی که از طریق تعدادی زیادی ریز سرویس‌ها به کاربران محتوا ارائه می دهد، می تواند یک تاپیک واحد برای بازدید از یک صفحه داشته باشد که همه سرویس‌ها بتوانند داده‌های خود را در یک فرمت مشترک در این تاپیک بنویسند. برنامه‌های مصرف کننده می توانند بدون نیاز به هماهنگی از چندین تاپیک داده‌ها را دریافت کنند.

- چندین مصرف کننده (Multiple Consumers)

علاوه بر تولید کنندگان متعدد، کافکا برای چندین مصرف کننده نیز طراحی شده است تا جریان پیام را بدون دخالت در یکدیگر بخوانند. این در تضاد با بسیاری از سامانه‌های صف‌بندی (queuing systems) است که وقتی یک پیام توسط یک کلاینت مصرف می شود، در دسترس دیگران نیست. چندین مصرف‌کننده می توانند به عنوان بخشی از یک گروه فعالیت کنند و یک جریان داده را به اشتراک بگذارند و اطمینان حاصل شود که کل گروه فقط یک بار یک پیام را پردازش می کنند.

- نگهداری بر پایه حافظه ثابت (Disk-Based Retention)

حفظ پیام با دوام به این معنی است که مصرف کنندگان همیشه نیازی به کار در زمان بلادرنگ ندارند. پیام ها در دیسک با قوانین نگهداری قابل تنظیم ذخیره می شوند. این گزینه ها می توانند برای هر تاپیک به صورت جداگانه تنظیم شوند و این امکان را برای جریان های مختلف پیام فراهم می کند که بسته به نیاز مصرف کننده مقدار مختلفی از ماندگاری را داشته باشند. ماندگاری به این معنی است که اگر مصرف کننده عقب بیفتد یا به دلایلی با ترافیک زیادی روبرو ‌شویم خطر از دست دادن داده وجود ندارد. مصرف کنندگان می توانند متوقف شوند و پیام ها در کافکا حفظ شود. این بدان معنی است که می توان تعمیر و نگهداری را بر روی مصرف کنندگان انجام داد و برنامه ها را برای مدت کوتاهی آفلاین کرد و هیچ نگرانی در مورد پشتیبان گیری پیام از سمت تولید کننده یا گم شدن آنها وجود نداشته باشد. این به ما این امکان را می دهد تا پیام های پردازشی را بدون نیاز به از دست دادن داده، از همانجا که قبلا پردازش متوقف شده است دوباره راه‌اندازی و شروع به پردازش کنیم.

- مقیاس پذیری (Scalable)

مقیاس پذیری منعطف کافکا، مدیریت هر مقدار داده را آسان می کند. کاربران می توانند با استفاده از یک کارگزار شروع به کار کنند و به یک خوشه کوچک متشکل از سه کارگزار گسترش یابد و با گذشت زمان و افزایش رشد داده‌ها به یک خوشه بزرگتر از ده ها یا حتی صدها کارگزار توسعه پیدا کند. این توسعه می‌تواند در حالی که خوشه آنلاین است انجام شود و هیچ تأثیری بر در دسترس بودن سامانه به عنوان یک مشکل ندارد. این همچنین بدان معناست که مجموعه ای از کارگزاران می توانند شکست یک کارگزار را کنترل کرده و به سرویس دادن ادامه دهند. خوشه هایی که نیاز به تحمل خرابی های همزمان بیشتر دارند را می توان با فاکتورهای تکثیر بالاتر (replication factors) پیکربندی کرد.

- عملکرد بالا (High Performance)

همه این ویژگی ها با هم آپاچی کافکا را به یک سامانه با عملکرد عالی در بار زیاد تبدیل می‌کند. تولیدکنندگان، مصرف کنندگان و کارگزاران می توانند مقیاس پذیز باشند تا جریان های پیام بسیار بزرگ را به راحتی مدیریت کنند. این کار می تواند در حالی انجام شود که تأخیر (latency) انتقال پیام در ثانیه از تولید کننده به مصرف کنندگان کاهش پیدا کند.

برای بررسی ترافیک کافکا در GUI می‌توانید از نرم‌افزار [کنداکتور](https://www.conduktor.io/) استفاده کنید.

وظایف شما
=========

1. پرسش‌های نظری

   1. در مورد مفاهیم  pub/sub architecture و event-driven architecture تحقیق کنید.
   2. در مورد جایگزین‌های کافکا سرچ کنیدو ۳ مورد جایکزین را نام ببرید.
   3. topic و partition در کافکا به چه معنی است؟
   4. Retention در topic به چه معنا است و مقدار پیش‌فرض چه مقدار است؟
   5. Replication Factor در کافکا به چه معنی است ؟ به نظر شما مقدار مناسب چه عددی است ؟
   6. consumer group در کافکا به چه معنی است ؟ و در صورتی که دو مصرف کننده در یک consumer group یکسان باشد چه اتفاقی می‌افتد؟
   7. چگونه امکان دارد که دیتاهای مرتبط با یکدیگر در یک پارتیشن دخیره شوند و توسط یک مصرف کننده پردازش شوند؟

2. [تمرین عملی](Project.md)


## مطالب بیشتر برای مطالعه

برای اجرای یک خوشه کافکا می‌توانید به  [APACHE KAFKA QUICKSTART](https://kafka.apache.org/quickstart) مراجعه کنید و همچنین
برای توسعه یک تولید کننده و مصرف کننده با استفاده از spring boot می‌توانید به [Spring Boot - Apache Kafka](https://www.tutorialspoint.com/spring_boot/spring_boot_apache_kafka.htm) مراجعه نمایید

همچنین می‌توانید از ویدیوهای زیر برای درک بیشتر نحوه کارکرد کافکا استفاده کنید:
1. [Event Driven Architecture](https://www.youtube.com/watch?v=o2HJCGcYwoU)
1. [What is kafka](https://www.youtube.com/watch?v=aj9CDZm0Glc)
2. [Apache Kafka in 6 minutes](https://www.youtube.com/watch?v=Ch5VhJzaoaI)
3. [Spring Boot with Spring Kafka Producer Example](https://www.youtube.com/watch?v=NjHYWEV_E_o)


</div>